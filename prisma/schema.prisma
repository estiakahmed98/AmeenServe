// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MANAGER
  TECHNICIAN
  USER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BANNED
}

enum KycStatus {
  NOT_SUBMITTED
  PENDING
  VERIFIED
  REJECTED
}

enum OrderStatus {
  REQUESTED      
  PENDING        
  ACCEPTED       
  ARRIVING     
  STARTED       
  IN_PROGRESS   
  COMPLETED      
  CANCELLED      
  NO_SHOW        
}

enum TrackingSource {
  TECH_APP
  CUSTOMER_APP
  SERVER
}

enum PaymentStatus {
  UNPAID
  AUTHORIZED
  PAID
  REFUNDED
  FAILED
}

enum PayoutStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
}

enum DevicePlatform {
  WEB
  ANDROID
  IOS
}

enum NotificationType {
  SYSTEM
  ORDER
  PAYMENT
  KYC
}

enum DayOfWeek {
  SUN
  MON
  TUE
  WED
  THU
  FRI
  SAT
}

model User {
  id            String       @id @default(uuid())
  name          String?
  email         String?      @unique
  emailVerified DateTime?
  image         String?

  phone         String?      @unique
  passwordHash  String?

  role          Role         @default(USER)
  status        UserStatus   @default(ACTIVE)

  fullName      String?
  city          String?
  address       String?
  accounts      Account[]
  sessions      Session[]
  orders        Order[]      @relation("CustomerOrders")
  notifications Notification[]
  devices       Device[]
  addresses     UserAddress[]
  reviews       Review[]     @relation("UserReviews")
  auditLogs     AuditLog[]   @relation("AuditActor")
  verifiedKycDocs KycDocument[] @relation("VerifiedByUser")
  statusEvents  OrderStatusEvent[] @relation("StatusActor")

  // Technician fields (used when role = TECHNICIAN)
  bio              String?
  yearsExperience  Int?
  skills           String[]            @default([])
  kycStatus        KycStatus           @default(NOT_SUBMITTED)
  ratingAvg        Decimal             @default(0) @db.Decimal(4,2)
  ratingCount      Int                 @default(0)
  isOnline         Boolean             @default(false)
  lastSeen         DateTime?
  currentLat       Decimal?            @db.Decimal(10,7)
  currentLng       Decimal?            @db.Decimal(10,7)
  serviceRadiusKm  Decimal?            @db.Decimal(6,2)

  // Back-relations for technician
  technicianServices TechnicianService[] @relation("TechnicianServices")
  availability       AvailabilitySlot[]
  kycDocs            KycDocument[] @relation("TechnicianKycDocs")
  technicianReviews  Review[]      @relation("TechnicianReviews")
  payouts            Payout[]
  techOrders         Order[]             @relation("TechnicianOrders")

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([role])
  @@index([status])
  @@index([isOnline, lastSeen])
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Service {
  id          String             @id @default(uuid())
  name        String
  slug        String             @unique
  description String?
  price       Decimal?           @db.Decimal(12,2)
  unit        String?            
  isActive    Boolean            @default(true)

  technicians TechnicianService[]
  orders      Order[]

  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
}

// Technician model removed; merged into User

model TechnicianService {
  id           String     @id @default(uuid())
  technicianId String
  serviceId    String
  priceOverride Decimal?  @db.Decimal(12,2)
  isActive     Boolean    @default(true)

  technician   User       @relation("TechnicianServices", fields: [technicianId], references: [id], onDelete: Cascade)
  service      Service    @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([technicianId, serviceId])
}

model AvailabilitySlot {
  id            String       @id @default(uuid())
  technicianId  String
  dayOfWeek     DayOfWeek?   
  startTimeUTC  String?      
  endTimeUTC    String?      
  dateUTC       DateTime?    
  startAtUTC    DateTime?
  endAtUTC      DateTime?
  timezone      String?      
  technician    User         @relation(fields: [technicianId], references: [id], onDelete: Cascade)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([technicianId, dayOfWeek])
  @@index([dateUTC])
}

model Order {
  id             String        @id @default(uuid())
  code           String        @unique
  userId         String
  technicianId   String?
  serviceId      String
  address        String
  latitude       Decimal?      @db.Decimal(10,7)
  longitude      Decimal?      @db.Decimal(10,7)
  status         OrderStatus   @default(REQUESTED)
  scheduledAt    DateTime?
  startedAt      DateTime?
  completedAt    DateTime?
  cancelledAt    DateTime?
  cancelReason   String?
  priceQuoted    Decimal?      @db.Decimal(12,2)
  priceFinal     Decimal?      @db.Decimal(12,2)
  currency       String        @default("BDT")
  user           User          @relation("CustomerOrders", fields: [userId], references: [id], onDelete: Cascade)
  technician     User?         @relation("TechnicianOrders", fields: [technicianId], references: [id])
  service        Service       @relation(fields: [serviceId], references: [id], onDelete: Restrict)
  tracking       TrackingEvent[]
  statusHistory  OrderStatusEvent[]
  payment        Payment?
  review         Review?
  notifications  Notification[] @relation("OrderNotifications")
  meta           Json?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([userId, status, scheduledAt])
  @@index([technicianId, status])
  @@index([serviceId])
  @@index([latitude, longitude])
}

model TrackingEvent {
  id         String         @id @default(uuid())
  orderId    String
  source     TrackingSource @default(SERVER)
  latitude   Decimal?       @db.Decimal(10,7)
  longitude  Decimal?       @db.Decimal(10,7)
  accuracyM  Decimal?       @db.Decimal(6,2)
  headingDeg Decimal?       @db.Decimal(6,2)
  speedKph   Decimal?       @db.Decimal(6,2)
  note       String?
  order      Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  createdAt  DateTime       @default(now())

  @@index([orderId, createdAt])
}

model OrderStatusEvent {
  id         String       @id @default(uuid())
  orderId    String
  from       OrderStatus?
  to         OrderStatus
  actorId    String?      
  actor      User?        @relation("StatusActor", fields: [actorId], references: [id])
  reason     String?
  at         DateTime     @default(now())

  order      Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId, at])
  @@index([to])
}

model Review {
  id           String    @id @default(uuid())
  orderId      String    @unique
  userId       String
  technicianId String
  rating       Int       
  comment      String?

  order        Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user         User      @relation("UserReviews", fields: [userId], references: [id], onDelete: Cascade)
  technician   User      @relation("TechnicianReviews", fields: [technicianId], references: [id], onDelete: Cascade)

  createdAt    DateTime  @default(now())

  @@index([technicianId])
  @@index([userId])
}

model Payment {
  id             String        @id @default(uuid())
  orderId        String        @unique
  amount         Decimal       @db.Decimal(12,2)
  currency       String        @default("BDT")
  status         PaymentStatus @default(UNPAID)
  method         String?       
  transactionRef String?
  paidAt         DateTime?

  order          Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}

model Payout {
  id            String       @id @default(uuid())
  technicianId  String
  amount        Decimal      @db.Decimal(12,2)
  currency      String       @default("BDT")
  status        PayoutStatus @default(PENDING)
  periodStart   DateTime
  periodEnd     DateTime
  paidAt        DateTime?

  technician    User         @relation(fields: [technicianId], references: [id], onDelete: Cascade)

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([technicianId, status])
}

model KycDocument {
  id            String     @id @default(uuid())
  technicianId  String
  type          String     
  url           String
  status        KycStatus  @default(PENDING)
  verifiedById  String?
  verifiedBy    User?      @relation("VerifiedByUser", fields: [verifiedById], references: [id])
  verifiedAt    DateTime?

  technician    User       @relation("TechnicianKycDocs", fields: [technicianId], references: [id], onDelete: Cascade)

  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@index([technicianId, status])
}

model UserAddress {
  id         String   @id @default(uuid())
  userId     String
  label      String?  
  address    String
  latitude   Decimal? @db.Decimal(10,7)
  longitude  Decimal? @db.Decimal(10,7)
  isDefault  Boolean  @default(false)

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId, isDefault])
}

model Device {
  id         String         @id @default(uuid())
  userId     String
  platform   DevicePlatform @default(WEB)
  token      String?        
  lastSeen   DateTime?

  user       User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  @@index([userId, platform])
}

model Notification {
  id         String           @id @default(uuid())
  userId     String
  orderId    String?
  type       NotificationType @default(SYSTEM)
  title      String
  body       String
  data       Json?
  readAt     DateTime?

  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  order      Order?           @relation("OrderNotifications", fields: [orderId], references: [id])

  createdAt  DateTime         @default(now())

  @@index([userId, createdAt])
  @@index([orderId])
}

model AuditLog {
  id         String   @id @default(uuid())
  actorId    String?
  actor      User?    @relation("AuditActor", fields: [actorId], references: [id])
  action     String   
  targetType String   
  targetId   String?
  meta       Json?

  createdAt  DateTime @default(now())

  @@index([actorId, createdAt])
  @@index([targetType, targetId])
}
